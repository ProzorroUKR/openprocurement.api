АРМА
====

Етап 1: Складний актив
----------------------

Загальний опис
~~~~~~~~~~~~~~

Створити новий тип закупівлі (``procurementMethodType``) на основі aboveThrehsoldEU. Налаштувати обмеження конфіграцій. Відключити непотрібну функціональність. Реалізувати новий тип ``value`` для проведення тедеру по розміру винагороди (у відсотках).

https://prozorro-ua.atlassian.net/wiki/spaces/Knowledge/pages/578715650

https://prozorro-ua.atlassian.net/wiki/spaces/Knowledge/pages/594870280

https://prozorro-ua.atlassian.net/wiki/spaces/Knowledge/pages/637698053

Загальний план
~~~~~~~~~~~~~~

API ЦБД
"""""""

- Створити новий тип тендера

  - Створити новий модуль тендерінгу з новим ``procurementMethodType`` (див. нижче)
  - Налаштувати для нового типу процедури словники standards (див. нижче)
  - Відключити непотрібну функціональність (див. нижче)
  - Реалізувати новий тип поля ``value`` (див. нижче)

    - Нова структура поля ``value`` (див. нижче)
    - Робота аукіона з новою структурою поля ``value`` (див. нижче)

  - Заборонити використання ``contractTemplateName``
  - Адаптувати логіку роботи milestones (див. нижче)
  - Повний набір тестів процедури по аналогії з іншими типами процедур

- Налаштувати роботу контрактів

  - Реалізувати роботу з новим типом поля ``value``

    - Створення контракту
    - Оновлення контракту
    - Зміни до контракту

  - Заборонити використання ``contractTemplateName``
  - Змінити логіку роботи ``amountPaid``
  - Тести для нового типа поля ``value``

- Оновлення документації

  - Структура нового ``value``
  - Туторіал нової процедури

- Білінг

Модуль аукціонів
""""""""""""""""

Роботи не передбачаються. ЦБД виконує двусторонню конвертацію ``value`` в/з старого формату

Рендеріг (PDF контракту по темплейту)
"""""""""""""""""""""""""""""""""""""

Роботи не передбачаються за умови заборони використання через заборону ``contractTemplateName`` в tender/contract.

Якщо передбачається:

- Адаптувати під ``value.amountPercentage``
- Перевірити чи присутні всі поля необхідні для теплейту

Білінг
""""""

Реалізувати нову логіку білінгу.

https://prozorro-ua.atlassian.net/wiki/spaces/Knowledge/pages/637960193

Ризик індикатори
""""""""""""""""

Не мають спрацьовувати.

Роботи не передбачаються, але:

- Переконатися що для нового ``procurementMethodType`` ризик індикатори не спрацьовують
- Додати виключення нового типу з розрахунків ризик індикаторів (якщо необхідно)

Інтеграції
""""""""""

Інтеграції не передбачені в першій ітерації, але необхідно переконатися що вони не вимагають поля ``value.currency`` або ``value.amount`` в стандартному форматі.

Потенційно необхідні інтеграції:

- ЄДР
- ДФС
- НАЗК

Створити новий модуль тендерінгу з новим ``procurementMethodType``
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Створити новий модуль тендерінгу з новим ``procurementMethodType`` на основі модуля openeu (aboveThresholdEU)

Налаштувати для нового типу процедури словники standards
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Налаштувати конфігурації для створення процедури відповідно до ТЗ
"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""

https://github.com/ProzorroUKR/standards/tree/master/data_model/schema/TenderConfig

https://prozorro-ua.atlassian.net/wiki/spaces/Knowledge/pages/594870280

Налаштувати перелік обов'язкових критеріїв
""""""""""""""""""""""""""""""""""""""""""

https://github.com/ProzorroUKR/standards/tree/master/criteria/rules

https://prozorro-ua.atlassian.net/wiki/spaces/Knowledge/pages/594870280

https://prozorro-ua.atlassian.net/wiki/spaces/Knowledge/pages/637698053

Деякі валідації критеріїв можуть потребувати змін в цбд.

Налаштувати перелік дозволених типів організацій
""""""""""""""""""""""""""""""""""""""""""""""""

https://github.com/ProzorroUKR/standards/blob/master/organizations/kind_procurementMethodType_mapping.json

Перелік значень для нового типу процедури

.. code-block:: json

   [
     "authority",
   ]

Відключити непотрібну функціональність
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

https://prozorro-ua.atlassian.net/wiki/spaces/Knowledge/pages/594870280

https://prozorro-ua.atlassian.net/wiki/spaces/Knowledge/pages/637698053

Відключити обов'язковість критеріїв
""""""""""""""""""""""""""""""""""""

Відключити обов'язковість критеріїв. Див. вище.

Відключити обов'язковість ``tender.milestones``
"""""""""""""""""""""""""""""""""""""""""""""""

Відключити обов'язковість ``tender.milestones`` (і відповідно ``contract.milestones``) з типами:

- delivery
- financing

.. code-block:: python

   def validate_milestones(self, data, value):
       if tender_created_after(MILESTONES_VALIDATION_FROM):
           if value is None or len(value) < 1:
               raise ValidationError("Tender should contain at least one milestone")

Нова структура поля value
~~~~~~~~~~~~~~~~~~~~~~~~~

Реалізувати нову структуру ``value`` oщо буде використана в полях (якщо тендер має відповідний ``procurementMethodType``)

- ``tender.value``
- ``tender.bids[].value``
- ``tender.awards[].value``
- ``contract.value``

Варіант 1
"""""""""

Структура
'''''''''

- Інша назва поля по аналогії з esco
- Прибрати поля currency/valueAddedTaxIncluded

.. code-block:: json

   {
       "value": {
           "amountPercentage": 30.5
       }
   }

Валідації
'''''''''

Валідації для ``tender.value`` (відповідно і для ``tender.lots[].value``):

- ``tender.value.amountPercentage`` >= 0
- ``tender.value.amountPercentage`` <= 100

Валідації для ``tender.bids[].value`` (відповідно і для ``tender.bids[].lotValues[].value``):

- ``tender.bids[].value.amountPercentage`` >= 0
- ``tender.bids[].value.amountPercentage`` <= ``tender.value.amountPercentage``

Валідації для ``contract.value``:

- ``contract.value.amountPercentage`` >= 0
- ``contract.value.amountPercentage`` <= ``tender.awards[].value.amountPercentage``

Перевірити/адаптувати всі інші валідації що використовували поля:

- ``value.amount``
- ``value.amountNet``
- ``value.currency``
- ``value.valueAddedTaxIncluded``

Авардінг
''''''''

Реалізувати визначення переможної пропозиції за полем ``tender.awards.value.amountPercentage``

.. code-block:: python

   awarding_criteria_key: str = "amountPercentage"

Аномально низька ціна (ALP)
'''''''''''''''''''''''''''

Налаштувати розрахунок аномально низької ціни за полем ``tender.awards.value.amountPercentage`` використовуючи значення ``awarding_criteria_key``:

Нецінові критерії
'''''''''''''''''

Не будуть застосовуватися. Заборонити використання поля ``tender.features[]`` в тендері.

Життєвий цикл
'''''''''''''

Не буде застосовуватися. Заборонити встановлення значення ``awardCriteria`` в полі ``tender.awardCriteria``

Розрахунок ``weightedValue``
''''''''''''''''''''''''''''


Поле ``weightedValue`` створюється на основі поля ``value`` якщо в тендері викорисовується неціновий критерій або життєвий цикл.
Оскільки нецінові критерії та життєвий цикл не будуть застосовуватися, поле ``weightedValue`` не буде створюватися. 

Але пропонється адаптувати його роботу за полем ``tender.awards.value.amountPercentage`` використовуючи значення ``awarding_criteria_key``, на випадок якщо вищеописана функціональність буде застосована в майбутньому.

Тобто для ``value``:

.. code-block:: json

   {
       "value": {
           "amountPercentage": 30.5
       }
   }

Генерувати (якщо вимагається умовами проведення тендера що описані вище) ``weightedValue``:

.. code-block:: json

   {
       "weightedValue": {
           "amountPercentage": 30.5б
           "addition": 100.0,
           "denominator": 0.5
       }
   }

Аукціон
'''''''

Реалізувати двусторонню конвертацію ``value`` (а також ``weightedValue`` за наявності) з старого формату в новий і в зворотньому напрямку.

Етап імпорту тендеру датабріджом аукціонів
''''''''''''''''''''''''''''''''''''''''''

ЦБД розуміючи що запит від модуля аукціона у відповіді переформатовує всі value. Використовуючи поле currency для позначення відсотків.

Наприклад

.. code-block:: json

   {
       "value": {
           "amountPercentage": 30.5
       }
   }

Конвертувати в:

.. code-block:: json

   {
       "value": {
           "amount": 30.5,
           "currency": "%"
       }
   }

Етап звітування аукціоном про результати
''''''''''''''''''''''''''''''''''''''''

В ендпоінті ЦБД для аукціона робити зворотню конвертацію

Адаптувати логіку роботи milestones
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Функціональність майлстоунів для нової процедури аналогічна стандартній функціональності майлстоунів за виключенням того що:

- alp dueDate має бути через 2 робочих дні після спрацювання
- alp для розрахкнців використовує значення поля ``tender.awards.value.amountPercentage`` (див. вище)

Перелік розглянутих реалізацій
------------------------------

Нова структура поля value
~~~~~~~~~~~~~~~~~~~~~~~~~

Варіант 1
"""""""""

- Інша назва поля по аналогії з esco
- Прибрати поля ``currency``/``valueAddedTaxIncluded``

.. code-block:: json

   {
       "value": {
           "amountPercentage": 30.5
       }
   }

Мінуси:

- спеціалізоване поле виключно під цей функціонал

Плюси:

- спеціалізоване поле виключно під цей функціонал

Варіант 2 (відкинуто)
"""""""""""""""""""""

- Залишити поле ``amount``
- Прибрати поля ``currency``/``valueAddedTaxIncluded``
- Додати поле ``unit``

Плюси:

- в майбутньому можна використовувати з іншими одиницями вимірювання

Мінуси:

- зміна логіки використання існуючого поля ``amount`` що може призвести до його неправильного трактування системами що не будуть знати про ці зміни

.. code-block:: json

   {
       "value": {
           "amount": 30.5,
           "unit": {
             "code": "P1",
             "name": "percent",
             "symbol": "%"
           }
       }
   }

Мінуси:

- спеціалізоване поле виключно під цей функціонал

Плюси:

- спеціалізоване поле виключно під цей функціонал

Робота аукіона з новою структурою поля value
""""""""""""""""""""""""""""""""""""""""""""

Варіант 1
"""""""""

Не змінювати модуль аукціону. Зміни в цбд.

На етапі імпорту тендеру датабріджом аукціонів
''''''''''''''''''''''''''''''''''''''''''''''

ЦБД розуміючи що запит від модуля аукціона у відповіді переформатовує всі ``value``. Використовуючи поле ``currency`` для позначення відсотків.

Наприклад

.. code-block:: json

   {
       "value": {
           "amountPercentage": 30.5
       }
   }

Конвертувати в:

.. code-block:: json

   {
       "value": {
           "amount": 30.5,
           "currency": "%"
       }
   }

На етапі звітування аукціоном про результати
''''''''''''''''''''''''''''''''''''''''''''

В ендпоінті ЦБД для аукціона робити зворотн конвертацію

Варіант 2 (відкинуто)
"""""""""""""""""""""

Конвертація в модулі акціонів

Конвертація на єтапі імпорту тендера в auction databridge
Зворотня конвертація на етапі публікації результатів в auction chronograph/databridge

Варіант 3 (відкинуто)
'''''''''''''''''''''

Повна адаптація модуля аукціонів

Всі модулі аукіона вміють працювати з новою структурою ``value``
