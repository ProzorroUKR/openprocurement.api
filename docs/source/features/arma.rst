АРМА
====

Етап 1: Складний актив
----------------------

Загальний опис
~~~~~~~~~~~~~~

Створити новий тип закупівлі (``procurementMethodType``) на основі aboveThrehsoldEU. Налаштувати обмеження конфіграцій. Відключити непотрібну функціональність. Реалізувати новий тип ``value`` для проведення тедеру по розміру винагороди (у відсотках).

`Закупівля АРМА (загальна інформація) <https://prozorro-ua.atlassian.net/wiki/spaces/Knowledge/pages/578715650>`_

`Процес відбору управителя складних активів <https://prozorro-ua.atlassian.net/wiki/spaces/Knowledge/pages/594870280>`_

`Різниця між структурами тендеру простого активу та складного активу <https://prozorro-ua.atlassian.net/wiki/spaces/Knowledge/pages/637698053>`_

Загальний план
~~~~~~~~~~~~~~

API ЦБД
"""""""

- Створити новий тип тендера

  - Створити новий модуль тендерінгу з новим ``procurementMethodType`` (див. нижче)
  - Налаштувати для нового типу процедури словники standards (див. нижче)
  - Відключити непотрібну функціональність (див. нижче)
  - Реалізувати новий тип поля ``value`` (див. нижче)

    - Нова структура поля ``value`` (див. нижче)
    - Робота аукіона з новою структурою поля ``value`` (див. нижче)

  - Відключити нецінові критерії (див. нижче)
  - Відключити життєвий цикл (див. нижче)
  - Заборонити використання ``contractTemplateName`` (див. нижче)
  - Адаптувати логіку роботи milestones (див. нижче)
  - Повний набір тестів процедури по аналогії з іншими типами процедур

- Налаштувати роботу контрактів

  - Реалізувати роботу з новим типом поля ``value``

    - Створення контракту
    - Оновлення контракту
    - Зміни до контракту

  - Змінити логіку роботи ``amountPaid``
  - Тести для нового типа поля ``value``

- Оновлення документації

  - Структура нового ``value``
  - Туторіал нової процедури

Модуль аукціонів
""""""""""""""""

Роботи не передбачаються. ЦБД виконує двусторонню конвертацію ``value`` в/з старого формату

Створити новий модуль тендерінгу з новим ``procurementMethodType``
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Створити новий модуль тендерінгу з новим ``procurementMethodType`` на основі модуля openeu (aboveThresholdEU)

Налаштувати для нового типу процедури словники standards
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Налаштувати конфігурації для створення процедури відповідно до ТЗ
"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""

https://github.com/ProzorroUKR/standards/tree/master/data_model/schema/TenderConfig

`Процес відбору управителя складних активів <https://prozorro-ua.atlassian.net/wiki/spaces/Knowledge/pages/594870280>`_

Налаштувати перелік обов'язкових критеріїв
""""""""""""""""""""""""""""""""""""""""""

https://github.com/ProzorroUKR/standards/tree/master/criteria/rules

`Процес відбору управителя складних активів <https://prozorro-ua.atlassian.net/wiki/spaces/Knowledge/pages/594870280>`_

`Різниця між структурами тендеру простого активу та складного активу <https://prozorro-ua.atlassian.net/wiki/spaces/Knowledge/pages/637698053>`_

Деякі валідації критеріїв можуть потребувати змін в цбд.

Налаштувати перелік дозволених типів організацій
""""""""""""""""""""""""""""""""""""""""""""""""

https://github.com/ProzorroUKR/standards/blob/master/organizations/kind_procurementMethodType_mapping.json

Перелік значень для нового типу процедури

.. code-block:: json

   [
     "authority",
   ]

Відключити непотрібну функціональність
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

`Процес відбору управителя складних активів <https://prozorro-ua.atlassian.net/wiki/spaces/Knowledge/pages/594870280>`_

`Різниця між структурами тендеру простого активу та складного активу <https://prozorro-ua.atlassian.net/wiki/spaces/Knowledge/pages/637698053>`_

Відключити обов'язковість критеріїв
""""""""""""""""""""""""""""""""""""

Відключити обов'язковість критеріїв. Див. вище.

Відключити обов'язковість ``tender.milestones``
"""""""""""""""""""""""""""""""""""""""""""""""

Відключити обов'язковість ``tender.milestones`` (і відповідно ``contract.milestones``) з типами:

- delivery
- financing

.. code-block:: python

   def validate_milestones(self, data, value):
       if tender_created_after(MILESTONES_VALIDATION_FROM):
           if value is None or len(value) < 1:
               raise ValidationError("Tender should contain at least one milestone")

Нова структура поля value
~~~~~~~~~~~~~~~~~~~~~~~~~

Реалізувати нову структуру ``value`` oщо буде використана в полях (якщо тендер має відповідний ``procurementMethodType``)

- ``tender.value``
- ``tender.bids[].value``
- ``tender.awards[].value``
- ``contract.value``

Структура
"""""""""

- Інша назва поля по аналогії з esco
- Прибрати поля currency/valueAddedTaxIncluded

.. code-block:: json

   {
       "value": {
           "amountPercentage": 30.5
       }
   }

Валідації
"""""""""

Валідації для ``tender.value`` (відповідно і для ``tender.lots[].value``):

- ``tender.value.amountPercentage`` >= 0
- ``tender.value.amountPercentage`` <= 100

Валідації для ``tender.bids[].value`` (відповідно і для ``tender.bids[].lotValues[].value``):

- ``tender.bids[].value.amountPercentage`` >= 0
- ``tender.bids[].value.amountPercentage`` <= ``tender.value.amountPercentage``

Валідації для ``contract.value``:

- ``contract.value.amountPercentage`` >= 0
- ``contract.value.amountPercentage`` <= ``tender.awards[].value.amountPercentage``

Перевірити/адаптувати всі інші валідації що використовували поля:

- ``value.amount``
- ``value.amountNet``
- ``value.currency``
- ``value.valueAddedTaxIncluded``

Авардінг
""""""""

Реалізувати визначення переможної пропозиції за полем ``tender.awards.value.amountPercentage``

.. code-block:: python

   awarding_criteria_key: str = "amountPercentage"

Аномально низька ціна (ALP)
"""""""""""""""""""""""""""

Налаштувати розрахунок аномально низької ціни за полем ``tender.awards.value.amountPercentage`` використовуючи значення ``awarding_criteria_key``:

Розрахунок ``weightedValue``
""""""""""""""""""""""""""""


Поле ``weightedValue`` створюється на основі поля ``value`` якщо в тендері викорисовується неціновий критерій або життєвий цикл.
Оскільки нецінові критерії та життєвий цикл не будуть застосовуватися, поле ``weightedValue`` не буде створюватися. 

Але пропонється адаптувати його роботу за полем ``tender.awards.value.amountPercentage`` використовуючи значення ``awarding_criteria_key``, на випадок якщо вищеописана функціональність буде застосована в майбутньому.

Тобто для ``value``:

.. code-block:: json

   {
       "value": {
           "amountPercentage": 30.5
       }
   }

Генерувати (якщо вимагається умовами проведення тендера що описані вище) ``weightedValue``:

.. code-block:: json

   {
       "weightedValue": {
           "amountPercentage": 30.5б
           "addition": 100.0,
           "denominator": 0.5
       }
   }

Аукціон
"""""""

Реалізувати двусторонню конвертацію ``value`` (а також ``weightedValue`` за наявності) з старого формату в новий і в зворотньому напрямку.

Етап імпорту тендеру датабріджом аукціонів
''''''''''''''''''''''''''''''''''''''''''

ЦБД розуміючи що запит від модуля аукціона у відповіді переформатовує всі value. Використовуючи поле currency для позначення відсотків.

Наприклад

.. code-block:: json

   {
       "value": {
           "amountPercentage": 30.5
       }
   }

Конвертувати в:

.. code-block:: json

   {
       "value": {
           "amount": 30.5,
           "currency": "%"
       }
   }

Етап звітування аукціоном про результати
''''''''''''''''''''''''''''''''''''''''

В ендпоінті ЦБД для аукціона робити зворотню конвертацію

Заборонити використання ``contractTemplateName``
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Заборонити встановлення значення для поля ``contractTemplateName`` на етапі створення тендера.

Відключити нецінові критерії
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Не будуть застосовуватися. Заборонити встановлення значення для поля ``tender.features[]`` на етапі створення тендера.

Відключити життєвий цикл
~~~~~~~~~~~~~~~~~~~~~~~~

Не буде застосовуватися. Заборонити встановлення значення ``awardCriteria`` в полі ``tender.awardCriteria``

Адаптувати логіку роботи milestones
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Функціональність майлстоунів для нової процедури аналогічна стандартній функціональності майлстоунів за виключенням того що:

- alp dueDate має бути через 2 робочих дні після спрацювання
- alp для розрахкнців використовує значення поля ``tender.awards.value.amountPercentage`` (див. вище)


Етап 2: Простий актив
----------------------

Загальний опис
~~~~~~~~~~~~~~

Створити новий тип відбору (``frameworkType``) та його похідних на основі requirementsForProposal. Налаштувати обмеження конфіграцій. Відключити непотрібну функціональність.

Створити новий тип закупівлі (``procurementMethodType``) на основі процедури складних активів. Налаштувати обмеження конфіграцій. Відключити непотрібну функціональність. Реалізувати новий тип ``value`` для проведення тедеру по розміру винагороди (у відсотках).

`Закупівля АРМА (загальна інформація) <https://prozorro-ua.atlassian.net/wiki/spaces/Knowledge/pages/578715650>`_

`Процес відбору управителя простих активів <https://prozorro-ua.atlassian.net/wiki/spaces/Knowledge/pages/607780865>`_

`Різниця між структурами тендеру простого активу та складного активу <https://prozorro-ua.atlassian.net/wiki/spaces/Knowledge/pages/637698053>`_

Загальний план
~~~~~~~~~~~~~~

TBD

Етап 3: Білінг
--------------

Загальний опис
~~~~~~~~~~~~~~

Реалізувати нову логіку білінгу.

`Розрахунок білінгу АРМА <https://prozorro-ua.atlassian.net/wiki/spaces/Knowledge/pages/637960193>`_

Етап 4: Інтеграції
------------------

Інтеграції не передбачені в першій ітерації, але необхідно переконатися що вони не вимагають поля ``value.currency`` або ``value.amount`` в стандартному форматі або адаптувати їх роботу для нового типу ``value``.

Потенційно необхідні інтеграції:

- ЄДР
- ДФС
- НАЗК