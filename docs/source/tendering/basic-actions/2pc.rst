.. _2pc:

Двофазний коміт
===============

.. _tender-2pc:

Механізм створення двофазного коміта
------------------------------------

Двофазний коміт пропонує механізм, завдяки якому в ЦБД будуть опубліковані тільки ті закупівлі, над якими майданчик має контроль і змогу самостійно скасувати їх дублікати.
 
Причиною виникнення дублікатів закупівель є ситуації, коли автор запиту на створення закупівлі не отримував відповіді від сервера про її створення, і, відповідно, повторював спробу, що призводило до дублювання закупівлі. Видалення таких закупівель вимагало адміністративного втручання.

Створення закупівлі за допомогою однофазного коміта
---------------------------------------------------

Відсилання однофазного запиту на створення закупівлі (`POST /tenders`), за “старим” механізмом, після якого закупівля створюється одразу в статусі ``active.enquiries``:

.. http:example:: ../belowthreshold/http/tutorial/tender-post-attempt-json-data.http
   :code:

Створення закупівлі за допомогою двофазного коміта
--------------------------------------------------

Закупівля стає доступною після успішного та послідовного виконання двох наступних запитів:

1. Створення закупівлі у статусі ``draft``.
2. Переведення закупівлі в статус ``active.enquiries`` окремим запитом (публікація).


Створення закупівлі
~~~~~~~~~~~~~~~~~~~

При запиті `POST /tenders` передається закупівля зі статусом ``draft``. В результаті виконання запиту віддається ``acc_token`` для подальшого управління закупівлею. 

.. http:example:: ../belowthreshold/http/tutorial/tender-post-2pc.http
   :code:

Закупівля зі статусом ``draft`` "невидима" в переліку `GET /tenders`. Її, зокрема, не помічає хронограф і не перемикає статуси.


Публікування закупівлі
~~~~~~~~~~~~~~~~~~~~~~

Запит `PATCH /tenders/{id}?acc_token=...`    ``{“data”:{“status”:”active.enquiries”}}`` змінює статус закупівлі (згідно із запитом) і, відповідно, цим публікує її (“візуалізує” її в переліку `GET /tenders`).

.. http:example:: ../belowthreshold/http/tutorial/tender-patch-2pc.http
   :code:
   
Всі закупівлі, які були створені в ЦБД, але не опубліковані, не будуть відображатись на майданчику і, відповідно, не будуть призводити до їх оголошення.

Повторення запиту на публікацію, у випадку проблем з отриманням відповіді від сервера, не буде спричиняти помилок.

Новий механізм доступний паралельно зі “старим”. “Старий”, імовірно, буде вимкнено в одному з наступних release-ів.

Робота з помилками
------------------

У випадку неуспішності запиту та/або 5xx помилки, перевірте модифікований об'єкт (закупівлю, пропозицію, контракт і т.п.), оскільки 5xx помилка не обов'язково означає, що запит не відбувся. Варто повторювати запит з певним інтервалом, доки він не пройде успішно. 

Детальніший опис помилок та рекомендацій щодо дій при їх виникненні описаний у розділі :ref:`Коди стану <errors>`.

Ось приклад помилки неправильно сформованого запиту. Ця помилка вказує, що `data` не знайдено у тілі JSON.

.. http:example:: ../belowthreshold/http/tutorial/tender-post-attempt-json.http
   :code:

